name: GTM Automation

on:
  repository_dispatch:
    types: [run-gtm]

jobs:
  run_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run GTM pipeline
        env:
          APOLLO_API_KEY: ${{ secrets.APOLLO_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "=== STEP 1: Scraping TechSparks ==="
          python scrapers/techsparks_scraper.py

          echo "=== STEP 2: Apollo Enrichment ==="
          python enrichment/apollo_enricher.py --limit 10

          echo "=== STEP 3: ICP Scoring ==="
          python enrichment/icp_scorer.py

          echo "=== STEP 4: Deduplication ==="
          python enrichment/deduplicator.py

          echo "=== STEP 5: Persona Generation (Claude) ==="
          python persona_generation/persona_generator.py --limit 10

          echo "=== STEP 6: Lead Routing ==="
          python routing/lead_router.py

          echo "=== STEP 7: Outreach Message Builder ==="
          python outreach/message_builder.py --limit 10

      - name: Upload GTM CSV outputs
        uses: actions/upload-artifact@v4
        with:
          name: gtm-csv
          path: |
            data/**/*.csv
            *.csv
      - name: Notify Make (CSV ready)
        run: |
          curl -X POST https://hook.us2.make.com/yt9rrfk8fin2xnyjuj1yj47z31o8kbwq


      
